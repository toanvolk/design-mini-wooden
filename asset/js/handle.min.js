var indexJs={const:{HtmlClientContent:'<div class="input-group mb-3 cs-data-input"><span class="input-group-text cs-input-group-text bd-data bd-name" data-field="name"></span><input type="number"class="form-control bd-data bd-w"placeholder="W" data-field="w" readonly><input type="number"class="form-control bd-data bd-h"placeholder="H" data-field="h" readonly><input type="number"class="form-control bd-data bd-quanlity" placeholder="Số lượng" data-field="quantity"><button class="btn btn-danger cs-btn-remove-item">-</button></div>',constantZOOM:1,projectListString:"woodle_list_private",projectConfigString:"woodle_config_client",publicKeyString:"woodle_public_key",privateKeyString:"woodle_private_key"},data:{permission:{publicKey:function(){let t=localStorage.getItem(indexJs.const.publicKeyString);return null==t&&(t=Date.now(),localStorage.setItem(indexJs.const.publicKeyString,t)),t},privateKey:function(){let t=localStorage.getItem(indexJs.const.privateKeyString);return t}},config:{w:1200,h:2400,x:360,y:720,get:function(){let t=localStorage.getItem(indexJs.const.projectConfigString);return null!=t?JSON.parse(t):{zoomPrint:100}},set:function(t){localStorage.setItem(indexJs.const.projectConfigString,JSON.stringify(t))}},client:[]},projectList:[],init:function(){indexJs.isPermission(),$(".cs-setup .cs-data").text("W: "+indexJs.data.config.w+" | H: "+indexJs.data.config.h+" (đơn vị: mm)");let t=localStorage.getItem(this.const.projectListString);null!=t&&(indexJs.projectList=JSON.parse(t)),this.loadProjectList(),indexJs.reload()},isPermission:function(){let t=String((new Date).getMonth()+1).padStart(2,"0"),e=indexJs.data.permission.publicKey(),n=indexJs.data.permission.privateKey();$.MD5(e+t)!==n&&(window.location.href="./login.html")},convertToDisplay:function(t){return t*this.const.constantZOOM},convertUnitToPercent:function(t,e){return"w"==e||"x"==e?t/this.data.config.w*100:t/this.data.config.h*100},convertRealSize:function(t){return t/this.const.constantZOOM},reload:function(){$(".cs-client-content").html(""),$.each(indexJs.data.client,function(t,e){$(".cs-client-content").append(function(){return $(indexJs.const.HtmlClientContent).attr("id",e.id).find(".bd-data").each(function(n,i){let o=$(i).data("field");$(i).is("input")?$(i).val(e[o]):$(i).text(t+1)}).parent()})}),$("input.bd-data.bd-quanlity").change(function(){let t=$(this).closest(".cs-data-input").attr("id"),e=indexJs.data.client.find(e=>e.id==t);e.quantity=this.value,indexJs.reload()}),$(".cs-btn-remove-item").click(function(){let t=$(this).closest(".cs-data-input").attr("id"),e=indexJs.data.client.findIndex(function(e){return e.id==t});-1!==e&&indexJs.data.client.splice(e,1),indexJs.reload()}),indexJs.designAuto()},loadProjectList:function(){$(".project-list").html("");let t='<table class="table project-list-table"><thead><tr><th scope="col">#</th><th scope="col">Tên dự án</th><th scope="col">Ngày tạo</th></tr></thead><tbody>{list-source}</tbody></table>',e="",n=0;indexJs.projectList.sort(function(t,e){return e.localeCompare(t)}),indexJs.projectList.forEach(t=>{n++;let i=JSON.parse(localStorage.getItem(t));e+='<tr data-id="'+i.id+'"><th scope="row">'+n+'</th><td><p class="text-info btn-choose-project cs-pointer">'+i.projectName+"</p></td><td>"+i.createTime+"</td></tr>"}),t=t.replace("{list-source}",e),$(".project-list").append($(t)),$("p.btn-choose-project").click(function(){let t=$(this).closest("tr").data("id"),e=localStorage.getItem(t);indexJs.mapSourceProject(JSON.parse(e)),$("#project-list").modal("hide")})},mapSourceProject:function(t){if($("input.cs-project-name").prop("data",t),null==t)$("input.cs-project-name").val(""),$("input#distinguish-w-h").prop("checked",!0),indexJs.data.client=[];else{let e=!0;null!=t.isDistinguishWidthAndHeight&&(e=t.isDistinguishWidthAndHeight),$("input.cs-project-name").val(t.projectName),$("input#distinguish-w-h").prop("checked",e),indexJs.data.client=t.dataSource}indexJs.reload()},designAuto:function(){indexJs.clearContentItem();let t=[],e=[],n=$("input#distinguish-w-h").prop("checked"),i={x:0,y:0,w:this.convertToDisplay(this.data.config.w),h:this.convertToDisplay(indexJs.data.config.h)},o=0;$.each(indexJs.data.client,function(t,n){for(let i=0;i<n.quantity;i++){let i={name:t+1,w:indexJs.convertToDisplay(n.w),h:indexJs.convertToDisplay(n.h)};e.push(i)}o+=2*(Number(n.w)+Number(n.h))*Number(n.quantity)}),e.sort(function(t,e){return parseFloat(e.h)-parseFloat(t.h)});let a=0,c="",s=e.length,l=0;for(;e.length>0;){0==t.length&&(l++,c=cs_common.newId(),a+=1,t.push(i),indexJs.addContent(c,a));let o=t.length-1,s=t[o],r=!0;for(let i=0;i<e.length;i++){let a=e[i];if(s.w>=a.w&&s.h>=a.h){e.splice(i,1);let n={name:a.name,x:s.x,y:s.y,w:a.w,h:a.h};indexJs.addContentItem(c,n);let l={x:s.x,y:s.y+a.h,w:s.w,h:s.h-a.h},d={x:s.x+a.w,y:s.y,w:s.w-a.w,h:a.h};t.splice(o,1),t.push(l,d),r=!1;break}if(!n){let l=a.w;if(a.w=a.h,a.h=l,s.w>=a.w&&s.h>=a.h){e.splice(i,1);let l={name:a.name,x:s.x,y:s.y,w:a.w,h:a.h};indexJs.addContentItem(c,l,!n);let d={x:s.x,y:s.y+a.h,w:s.w,h:s.h-a.h},p={x:s.x+a.w,y:s.y,w:s.w-a.w,h:a.h};t.splice(o,1),t.push(d,p),r=!1;break}l=a.w,a.w=a.h,a.h=l}}r&&t.splice(o,1),t.removeIf(function(t,e){return 0==t.w||0==t.h}),t.sort(function(t,e){return parseFloat(e.w)-parseFloat(t.w)})}$("span.cs-quantity-cut").html("<b>"+s+"</b>"),$("span.cs-quantity-big").html("<b>"+l+"</b>"),o>0&&($("span.cs-total-circumference").html("<b>"+o+"(mm) -> "+o/1e3+"(m) </b>"),$("span.cs-total-skein").html("<b>"+Math.ceil(o/1e5)+" (cuộn) </b>")),console.log("regs Len:"+t.length)},addContent:function(t,e){let n='<div class="cs-view-detail" id="'+t+'"><div class="cs-view-detail-title">Tấm '+e+'</div><div class="cs-view-detail-content content-'+e+'"></div></div>',i=$("#view-main");i.append($(n))},addContentItem:function(t,e,n=!1){let i=$("#"+t+" .cs-view-detail-content"),o=$('<div class="rect-item"><small title="'+this.convertRealSize(e.w)+"x"+this.convertRealSize(e.h)+'">('+this.convertRealSize(e.w)+"x"+this.convertRealSize(e.h)+")</small></div>").css({left:this.convertUnitToPercent(e.x,"x")+"%",top:this.convertUnitToPercent(e.y,"y")+"%",width:this.convertUnitToPercent(e.w,"w")+"%",height:this.convertUnitToPercent(e.h,"h")+"%"});n&&(o.addClass("cs-rect-convert"),o.prop("title","Hoán đổi rộng cao!")),i.append(o)},clearContentItem:function(){let t=$("#view-main");t.html("")},zoomView:function(t){$(".cs-view").css({zoom:t+"%"})}};